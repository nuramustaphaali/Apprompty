{% extends "base.html" %}

{% block content %}
<div class="docs-container">

    <div class="docs-header">
        <div>
            <h1 class="docs-title">{{ project.name }}</h1>
            <p class="docs-subtitle">Master Architecture Plan</p>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'dashboard' %}" class="btn-exit">
                Exit
            </a>
        </div>
    </div>

    <div class="layout-wrapper">
        
        <div class="sidebar">
            
            <div class="sidebar-group-title">Strategy</div>
            <button onclick="loadSection('overview')" class="doc-tab active" id="tab-overview">üìÑ 1. Overview & Vision</button>
            <button onclick="loadSection('features')" class="doc-tab" id="tab-features">‚ú® 2. Platform Features</button>
            
            <div class="sidebar-group-title">Engineering</div>
            <button onclick="loadSection('backend')" class="doc-tab" id="tab-backend">‚öôÔ∏è 3. Backend Arch</button>
            <button onclick="loadSection('database')" class="doc-tab" id="tab-database">üóÑÔ∏è 4. Database Schema</button>
            <button onclick="loadSection('api')" class="doc-tab" id="tab-api">üîå 5. API Spec</button>
            
            <div class="sidebar-group-title">Frontend & Design</div>
            <button onclick="loadSection('frontend')" class="doc-tab" id="tab-frontend">üé® 6. Frontend Structure</button>
            <button onclick="loadSection('ui_ux')" class="doc-tab" id="tab-ui_ux">üíÖ 7. UI Kit & Skills.md</button>
            
            <div class="sidebar-group-title">Execution</div>
            <button onclick="loadSection('setup')" class="doc-tab" id="tab-setup">üöÄ 8. Master Setup</button>
        </div>

        <div class="content-panel">
            
            <div class="toolbar">
                <span id="status-text" class="status-indicator">Ready</span>

                <div style="display: flex; gap: 8px;">
                    <button onclick="downloadCurrentSection()" id="btn-download" class="action-btn download-btn">
                        ‚¨á <span class="btn-text">Download</span>
                    </button>
                    <button onclick="regenerateCurrent()" id="btn-regen" class="action-btn regen-btn">
                        ‚Üª <span class="btn-text">Regenerate</span>
                    </button>
                </div>
            </div>

            <div class="scroll-area">
                
                <div id="loader" style="text-align: center; padding-top: 60px; display: none;">
                    <div style="font-size: 3em; animation: pulse 1s infinite;">üß†</div>
                    <p style="color: #6b7280; margin-top: 15px; font-weight: 500;">Architecting this section...</p>
                </div>
                
                <div id="prose-content" class="prose"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentSection = 'overview';
    let currentMarkdown = '';

    document.addEventListener('DOMContentLoaded', () => { loadSection('overview'); });

    async function loadSection(sectionKey, forceRegen = false) {
        currentSection = sectionKey;
        
        // 1. Sidebar Active State
        document.querySelectorAll('.doc-tab').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + sectionKey).classList.add('active');
        
        const loader = document.getElementById('loader');
        const content = document.getElementById('prose-content');
        const btnDownload = document.getElementById('btn-download');
        const btnRegen = document.getElementById('btn-regen');
        const statusText = document.getElementById('status-text');

        // 2. Set Loading State
        loader.style.display = 'block';
        content.style.display = 'none';
        btnDownload.style.display = 'none';
        btnRegen.style.display = 'none';
        statusText.innerText = "Thinking...";

        try {
            const response = await fetch("{% url 'get_doc_section' project.id %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ section: sectionKey, regenerate: forceRegen })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            currentMarkdown = data.markdown;

            content.innerHTML = data.html;
            statusText.innerText = "Up to date";
            
            loader.style.display = 'none';
            content.style.display = 'block';
            btnDownload.style.display = 'inline-flex';
            btnRegen.style.display = 'inline-flex';

        } catch (e) {
            loader.style.display = 'none';
            content.style.display = 'block';
            content.innerHTML = `<div style="padding: 20px; background: #fee2e2; color: #b91c1c; border-radius: 8px;">Error: ${e.message}</div>`;
        }
    }

    function regenerateCurrent() {
        if(confirm("Regenerate this section from scratch?")) loadSection(currentSection, true);
    }

    function downloadCurrentSection() {
        if (!currentMarkdown) return;
        const blob = new Blob([currentMarkdown], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `{{ project.name|slugify }}_${currentSection}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

<style>
    /* Base Container */
    .docs-container {
        max-width: 1200px; margin: 0 auto; height: 90vh; 
        display: flex; flex-direction: column; padding: 0 10px;
    }
    
    .docs-header {
        flex-shrink: 0; display: flex; justify-content: space-between; 
        align-items: center; margin-bottom: 15px; padding-top: 15px;
    }

    .docs-title { margin: 0; color: #111827; font-size: 1.4em; font-weight: 700; }
    .docs-subtitle { color: #6b7280; margin: 0; font-size: 0.9em; }

    .btn-exit {
        text-decoration: none; color: #4b5563; font-weight: 500; font-size: 0.9em; 
        padding: 8px 15px; border: 1px solid #e5e7eb; border-radius: 6px; background: white;
    }

    /* Layout Wrapper: Grid on Desktop, Stack on Mobile */
    .layout-wrapper {
        flex-grow: 1; display: flex;
        border: 1px solid #e5e7eb; border-radius: 12px; 
        overflow: hidden; background: white; 
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }

    /* Sidebar: Desktop */
    .sidebar {
        width: 260px;
        background: #f9fafb; border-right: 1px solid #e5e7eb; 
        padding: 15px; display: flex; flex-direction: column; 
        gap: 5px; overflow-y: auto; flex-shrink: 0;
    }
    
    .sidebar-group-title {
        font-size: 0.75em; font-weight: 700; color: #9ca3af; 
        text-transform: uppercase; margin-bottom: 5px; margin-top: 15px; padding-left: 10px;
    }

    .doc-tab {
        text-align: left; padding: 10px 12px; border: none; background: transparent;
        color: #4b5563; font-weight: 500; cursor: pointer; border-radius: 6px; 
        font-size: 0.9em; transition: all 0.1s; white-space: nowrap;
    }
    .doc-tab:hover { background: #e5e7eb; color: #111827; }
    .doc-tab.active { background: #fff; color: #2563eb; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    /* Content Area */
    .content-panel {
        flex-grow: 1; display: flex; flex-direction: column; min-width: 0; /* Prevents overflow */
    }

    .toolbar {
        border-bottom: 1px solid #e5e7eb; padding: 10px 20px; 
        background: white; display: flex; justify-content: flex-end; 
        gap: 10px; align-items: center; height: 50px; flex-shrink: 0;
    }

    .status-indicator { margin-right: auto; font-size: 0.9em; color: #6b7280; }

    .action-btn {
        font-size: 0.85em; background: white; border: 1px solid #d1d5db; 
        padding: 6px 12px; border-radius: 6px; cursor: pointer; display: none; 
        align-items: center; gap: 5px; font-weight: 600;
    }
    .download-btn { color: #059669; }
    .regen-btn { color: #dc2626; }

    .scroll-area {
        flex-grow: 1; overflow-y: auto; padding: 40px; background: white;
    }

    /* =========================================
       MOBILE RESPONSIVENESS (Max Width 768px)
       ========================================= */
    @media (max-width: 768px) {
        .docs-container { height: 95vh; padding: 0 5px; }
        
        /* Stack Sidebar on top */
        .layout-wrapper { flex-direction: column; }

        .sidebar {
            width: 100%; height: auto; border-right: none; 
            border-bottom: 1px solid #e5e7eb;
            flex-direction: row; /* Horizontal Scroll */
            overflow-x: auto; padding: 10px; gap: 8px;
            /* Hide scrollbar but keep functionality */
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .sidebar::-webkit-scrollbar { display: none; }

        .sidebar-group-title { display: none; /* Hide group titles on mobile to save space */ }

        .doc-tab {
            background: white; border: 1px solid #e5e7eb;
            padding: 8px 15px; flex-shrink: 0; /* Don't shrink tabs */
        }
        .doc-tab.active {
            border-color: #2563eb; background: #eff6ff;
        }

        /* Adjust Content Padding */
        .scroll-area { padding: 20px; }
        
        .toolbar { padding: 10px 15px; }
        .btn-text { display: none; } /* Hide text, show icons only on small screens */
        .action-btn { padding: 8px 12px; font-size: 1em; }
    }

    /* Markdown Typography Tweaks */
    .prose h1 { font-size: 1.6em; }
    /* Update this specific style to ensure code blocks have a background */
    .prose pre { 
        background: #1f2937; /* Dark background */
        color: #f3f4f6;      /* Light text */
        padding: 20px; 
        border-radius: 8px; 
        overflow-x: auto; 
        margin: 20px 0; 
        border: 1px solid #374151;
    }

    /* Force Table Visibility */
    .prose table { 
        width: 100%; 
        border-collapse: collapse; 
        margin: 25px 0; 
        font-size: 0.95em; 
        background-color: white; /* Ensure background is white */
        color: #374151; /* Ensure text is dark */
        border: 1px solid #e5e7eb;
    }
    
    .prose th { 
        background-color: #f3f4f6; /* Light gray header */
        color: #111827; /* Black header text */
        text-align: left; 
        padding: 12px; 
        border: 1px solid #e5e7eb; 
        font-weight: 700; 
    }
    
    .prose td { 
        padding: 12px; 
        border: 1px solid #e5e7eb; 
        color: #4b5563; 
        vertical-align: top;
    }
    
    /* Handle Overflow for wide tables */
    .prose { overflow-x: auto; }
    
    @keyframes pulse {
        0% { opacity: 0.6; transform: scale(0.95); }
        50% { opacity: 1; transform: scale(1); }
        100% { opacity: 0.6; transform: scale(0.95); }
    }
</style>
{% endblock %}