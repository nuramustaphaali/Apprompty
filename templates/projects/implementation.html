{% extends "base.html" %}

{% block content %}
<div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 80vh;">

    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow-y: auto; padding: 15px;">
        <h3 style="margin-top: 0; color: #111827;">Development Plan</h3>
        <p style="font-size: 0.8em; color: #6b7280; margin-bottom: 15px;">Click a task to generate code.</p>
        
        {% for phase in phases %}
        <div style="margin-bottom: 20px;">
            <div style="font-weight: 600; color: #374151; font-size: 0.9em; margin-bottom: 8px; text-transform: uppercase;">
                Phase {{ phase.phase }}: {{ phase.title }}
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 5px;">
                {% for task in phase.tasks %}
                <button 
                    onclick="loadTaskHelp('{{ task|escapejs }}', this)"
                    class="task-btn"
                    style="text-align: left; padding: 8px 10px; border: 1px solid #e5e7eb; background: white; border-radius: 4px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                    {{ task }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div style="display: flex; flex-direction: column; gap: 10px;">
        
        <div style="background: white; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <h2 id="active-task-title" style="margin: 0; font-size: 1.1em;">Select a task to begin</h2>
            <div id="loading-spinner" style="display: none; color: #2563eb; font-weight: 600;">
                âœ¨ Generating Code...
            </div>
        </div>

        <div style="flex-grow: 1; background: #1e1e1e; border-radius: 8px; padding: 20px; color: #d4d4d4; font-family: monospace; overflow-y: auto; border: 1px solid #333;">
            <div id="code-content" style="white-space: pre-wrap; line-height: 1.5;">
                (Code will appear here)
            </div>
        </div>
        
    </div>
</div>

<script>
    async function loadTaskHelp(taskName, btnElement) {
        // 1. UI Updates
        document.querySelectorAll('.task-btn').forEach(b => b.style.borderColor = '#e5e7eb');
        btnElement.style.borderColor = '#2563eb';
        
        document.getElementById('active-task-title').innerText = taskName;
        const codeDiv = document.getElementById('code-content');
        const spinner = document.getElementById('loading-spinner');
        
        codeDiv.innerHTML = '';
        spinner.style.display = 'block';

        try {
            // 2. Fetch from Backend
            const response = await fetch("{% url 'get_task_help' project.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ task: taskName })
            });
            
            const data = await response.json();
            
            // 3. Render Markdown-ish text simply
            // (You can add a markdown parser library later if you want)
            codeDiv.innerText = data.content;
            
        } catch (e) {
            codeDiv.innerText = "Error fetching help: " + e;
        } finally {
            spinner.style.display = 'none';
        }
    }
</script>
{% endblock %}